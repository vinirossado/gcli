package service

import (
	"context"
	"time"

	"github.com/pkg/errors"

	"{{ .ProjectName }}/source/model"
	"{{ .ProjectName }}/source/repository"
)

// ---- Request DTOs ----

type Create{{ .StructName }}Request struct {
{{ if .Properties }}{{ range $name, $type := .Properties }}	{{ $name }} {{ $type }} `json:"{{ snake $name }}" binding:"required"`
{{ end }}{{ else }}	// TODO: define fields — re-run with: gcli create all {{ lower .StructName }} field:type ...
{{ end }}}

type Update{{ .StructName }}Request struct {
	Id uint `json:"id" binding:"required"`
{{ if .Properties }}{{ range $name, $type := .Properties }}	{{ $name }} {{ $type }} `json:"{{ snake $name }}"`
{{ end }}{{ else }}	// TODO: define fields — re-run with: gcli create all {{ lower .StructName }} field:type ...
{{ end }}}

// ---- Response DTO ----

type {{ .StructName }}Response struct {
	Id        uint      `json:"id"`
{{ if .Properties }}{{ range $name, $type := .Properties }}	{{ $name }} {{ $type }} `json:"{{ snake $name }}"`
{{ end }}{{ else }}	// TODO: define fields — re-run with: gcli create all {{ lower .StructName }} field:type ...
{{ end }}	CreatedAt time.Time `json:"created_at"`
	UpdatedAt time.Time `json:"updated_at"`
}

func to{{ .StructName }}Response(m *model.{{ .StructName }}) *{{ .StructName }}Response {
	return &{{ .StructName }}Response{
		Id:        m.ID,
{{ range $name, $type := .Properties }}		{{ $name }}: m.{{ $name }},
{{ end }}		CreatedAt: m.CreatedAt,
		UpdatedAt: m.UpdatedAt,
	}
}

// ---- Interface ----

type {{ .StructName }}Service interface {
	GetAll{{ .StructName }}(ctx context.Context) ([]{{ .StructName }}Response, error)
	Get{{ .StructName }}ById(ctx context.Context, id uint) (*{{ .StructName }}Response, error)
	Create{{ .StructName }}(ctx context.Context, req *Create{{ .StructName }}Request) (*{{ .StructName }}Response, error)
	Update{{ .StructName }}(ctx context.Context, req *Update{{ .StructName }}Request) (*{{ .StructName }}Response, error)
	Delete{{ .StructName }}(ctx context.Context, id uint) error
}

// ---- Implementation ----

type {{ .StructNameLowerFirst }}Service struct {
	*Service
	{{ .StructNameLowerFirst }}Repository repository.{{ .StructName }}Repository
}

func New{{ .StructName }}Service(service *Service, {{ .StructNameLowerFirst }}Repository repository.{{ .StructName }}Repository) {{ .StructName }}Service {
	return &{{ .StructNameLowerFirst }}Service{
		Service:                       service,
		{{ .StructNameLowerFirst }}Repository: {{ .StructNameLowerFirst }}Repository,
	}
}

func (s *{{ .StructNameLowerFirst }}Service) GetAll{{ .StructName }}(ctx context.Context) ([]{{ .StructName }}Response, error) {
	items, err := s.{{ .StructNameLowerFirst }}Repository.GetAll{{ .StructName }}(ctx)
	if err != nil {
		return nil, err
	}
	responses := make([]{{ .StructName }}Response, 0, len(*items))
	for i := range *items {
		responses = append(responses, *to{{ .StructName }}Response(&(*items)[i]))
	}
	return responses, nil
}

func (s *{{ .StructNameLowerFirst }}Service) Get{{ .StructName }}ById(ctx context.Context, id uint) (*{{ .StructName }}Response, error) {
	item, err := s.{{ .StructNameLowerFirst }}Repository.Get{{ .StructName }}ById(ctx, id)
	if err != nil {
		return nil, err
	}
	return to{{ .StructName }}Response(item), nil
}

func (s *{{ .StructNameLowerFirst }}Service) Create{{ .StructName }}(ctx context.Context, req *Create{{ .StructName }}Request) (*{{ .StructName }}Response, error) {
	entity := &model.{{ .StructName }}{}
{{ range $name, $type := .Properties }}	entity.{{ $name }} = req.{{ $name }}
{{ end }}	if _, err := s.{{ .StructNameLowerFirst }}Repository.Create{{ .StructName }}(ctx, entity); err != nil {
		return nil, err
	}
	return to{{ .StructName }}Response(entity), nil
}

func (s *{{ .StructNameLowerFirst }}Service) Update{{ .StructName }}(ctx context.Context, req *Update{{ .StructName }}Request) (*{{ .StructName }}Response, error) {
	_, err := s.{{ .StructNameLowerFirst }}Repository.Get{{ .StructName }}ById(ctx, req.Id)
	if err != nil {
		return nil, errors.New("{{ .StructNameLowerFirst }} not found")
	}

	entity := &model.{{ .StructName }}{ID: req.Id}
{{ range $name, $type := .Properties }}	entity.{{ $name }} = req.{{ $name }}
{{ end }}	if _, err := s.{{ .StructNameLowerFirst }}Repository.Update{{ .StructName }}(ctx, entity); err != nil {
		return nil, err
	}
	return to{{ .StructName }}Response(entity), nil
}

func (s *{{ .StructNameLowerFirst }}Service) Delete{{ .StructName }}(ctx context.Context, id uint) error {
	_, err := s.{{ .StructNameLowerFirst }}Repository.Get{{ .StructName }}ById(ctx, id)
	if err != nil {
		return errors.New("{{ .StructNameLowerFirst }} not found")
	}
	return s.{{ .StructNameLowerFirst }}Repository.Delete{{ .StructName }}(ctx, id)
}
